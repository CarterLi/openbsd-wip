$OpenBSD$
--- src/tun.c.orig	Sat Jan 10 23:45:51 2015
+++ src/tun.c	Fri Feb 13 23:40:22 2015
@@ -45,10 +45,13 @@
 #include <main.h>
 #include <ccan/list/list.h>
 
-#ifdef __FreeBSD__
+#if defined(__FreeBSD__) || defined(__OpenBSD__)
 # include <net/if_var.h>
 # include <netinet/in_var.h>
 #endif
+#if defined(__OpenBSD__)
+# include <netinet6/in6_var.h>
+#endif
 
 #ifdef __linux__
 
@@ -177,7 +180,7 @@ int set_ipv6_addr(main_server_st * s, struct proc_st *
 	memset(&ifr, 0, sizeof(ifr));
 	ifr.ifr_addr.sa_family = AF_INET6;
 	ifr.ifr_flags |= IFF_UP | IFF_RUNNING;
-	strlcpy(ifr.ifr_name, oroc->tun_lease.name, IFNAMSIZ);
+	strlcpy(ifr.ifr_name, proc->tun_lease.name, IFNAMSIZ);
 
 	ret = ioctl(fd, SIOCSIFFLAGS, &ifr);
 	if (ret != 0) {
@@ -318,6 +321,44 @@ static int set_network_info(main_server_st * s, struct
 
 #include <ccan/hash/hash.h>
 
+#ifndef __linux__
+static int bsd_open_tun(void)
+{
+        int fd;
+        int s;
+	char tun_name[80];
+        struct ifreq ifr;
+	int unit_nr = 0;
+
+        fd = open("/dev/tun", O_RDWR);
+        if (fd == -1) {
+        	/* try iterating */
+		for (unit_nr = 0; unit_nr < 255; unit_nr++) {
+			snprintf(tun_name, sizeof(tun_name), "/dev/tun%d", unit_nr);
+			fd = open(tun_name, O_RDWR);
+# ifdef SIOCIFCREATE
+			if (fd == -1) {
+				/* cannot open tunXX, try creating it */
+		                s = socket(AF_INET, SOCK_DGRAM, 0);
+		                if (s < 0)
+		                        return -1;
+
+		                memset(&ifr, 0, sizeof(ifr));
+		                strncpy(ifr.ifr_name, tun_name + 5, sizeof(ifr.ifr_name) - 1);
+		                if (!ioctl(s, SIOCIFCREATE, &ifr))
+                		        fd = open(tun_name, O_RDWR);
+		                close(s);
+			}
+# endif
+			if (fd >= 0)
+				break;
+		}
+        }
+
+        return fd;
+}
+#endif
+
 int open_tun(main_server_st * s, struct proc_st *proc)
 {
 	int tunfd, ret, e;
@@ -391,7 +432,7 @@ int open_tun(main_server_st * s, struct proc_st *proc)
 	}
 #endif
 #else				/* freebsd */
-	tunfd = open("/dev/tun", O_RDWR);
+	tunfd = bsd_open_tun();
 	if (tunfd < 0) {
 		int e = errno;
 		mslog(s, NULL, LOG_ERR, "Can't open /dev/tun: %s\n",
@@ -445,7 +486,7 @@ void close_tun(main_server_st * s, struct proc_st *pro
 	}
 
 #ifdef SIOCIFDESTROY
-	int e;
+	int e, ret;
 	struct ifreq ifr;
 
 	if (proc->tun_lease.name[0] != 0) {
