- make hardcoded engine version in patches smarter
- see about enabling tests in ${WRKSRC}/test
- check if USE_NOBTCFI and USE_WXNEEDED are really needed?
- can system lua5.1 be used somehow?
- check if glob(3) use in DataDirLocater.cpp can be removed

- Fix segfault:

#0  0x00000a4dbee6a5f4 in sweeplist (L=0xa503327c700, p=0xa5023dcb000, count=23)
    at /usr/ports/pobj/spring-bar-105.1.1.1672/spring-bar-105.1.1.1672/rts/lib/lua/src/lgc.cpp:413
413           sweepwholelist(L, &gco2th(curr)->openupval);
#1  0x00000a4dbee6a9d1 in singlestep (L=0xa503327c700)
    at /usr/ports/pobj/spring-bar-105.1.1.1672/spring-bar-105.1.1.1672/rts/lib/lua/src/lgc.cpp:587
#2  0x00000a4dbee6a75a in luaC_step (L=0xa503327c700)
    at /usr/ports/pobj/spring-bar-105.1.1.1672/spring-bar-105.1.1.1672/rts/lib/lua/src/lgc.cpp:621
#3  0x00000a4dbee5e88a in lua_gc (L=0xa503327c700, what=5, data=1)
    at /usr/ports/pobj/spring-bar-105.1.1.1672/spring-bar-105.1.1.1672/rts/lib/lua/src/lapi.cpp:945
#4  0x00000a4dbe3d6b7b in CLuaHandle::CollectGarbage (this=0xa5016b74000, forced=false)
    at /usr/ports/pobj/spring-bar-105.1.1.1672/spring-bar-105.1.1.1672/rts/Lua/LuaHandle.cpp:3532
#5  0x00000a4dbebeadb0 in IterateEventClientList<std::__1::vector<CEventClient*, std::__1::allocator<CEventClient*> >, void (CEventClient::*)(bool), bool&> (list=..., 
    func=@0x7c53277b8598: &virtual table offset 1256, args=@0x7c53277b85af: false)
    at /usr/ports/pobj/spring-bar-105.1.1.1672/spring-bar-105.1.1.1672/rts/System/EventHandler.cpp:488
#6  0x00000a4dbebe0109 in CEventHandler::CollectGarbage (this=0xa4dbf70e658 <eventHandler>, 
    forced=false)
    at /usr/ports/pobj/spring-bar-105.1.1.1672/spring-bar-105.1.1.1672/rts/System/EventHandler.cpp:611
[...]

- Fix double free when exiting:
(gdb) bt                                        
#0  thrkill () at /tmp/-:3                                                                      
#1  0x332568e7225c194f in ?? ()                                                                 #2  0x0000058484e20dde in _libc_abort () at /usr/src/lib/libc/stdlib/abort.c:51
#3  0x0000058484e3ab47 in wrterror (d=0x584a720a1f0,                                        
    msg=0x58484dbbce8 "bogus pointer (double free?) %p")                                        
    at /usr/src/lib/libc/stdlib/malloc.c:320
[...]
#7  0x000005825fa33c65 in sm::GenericAllocator::Free (instance=0x0, p=0x584dc320810)            
    at /usr/ports/pobj/spring-bar-105.1.1.1672/spring-bar-105.1.1.1672/rts/lib/smmalloc/smmalloc
_generic.cpp:73
[...]
#10 0x000005825efe35ed in PassThroughPool<32u, 4194304ul>::freeMem (this=0x5847f060b80, 
    p=0x584dc320810)                                                                            
    at /usr/ports/pobj/spring-bar-105.1.1.1672/spring-bar-105.1.1.1672/rts/System/MemPoolTypes.h
:53

Beyond All Reason - crash after calling a menu after a little gameplay:
-----------------------------------------------------------------------

(Doesn't seem to happen in Zero-K)

Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x000005bfe9d863e9 in ?? () from /usr/X11R6/lib/modules/dri/iris_dri.so
[Current thread is 1 (process 480714)]
(gdb) bt
#0  0x000005bfe9d863e9 in ?? () from /usr/X11R6/lib/modules/dri/iris_dri.so
#1  0x000005bfe9d8620a in ?? () from /usr/X11R6/lib/modules/dri/iris_dri.so
#2  0x000005bd32877fda in LuaOpenGL::CallList (L=0x5c029fdd010)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/Lua/LuaOpenGL.cpp:4951
#3  0x000005bd32d140eb in luaD_precall (L=0x5c029fdd010, func=<optimized out>, nresults=0)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/ldo.cpp:320
#4  0x000005bd32d2b2b5 in luaV_execute (L=0x5c029fdd010, nexeccalls=<optimized out>)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/lvm.cpp:620
#5  0x000005bd32d145b2 in luaD_call (L=0x5c029fdd010, func=0x5c0002df0d0, nResults=-1)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/ldo.cpp:378
#6  0x000005bd32d14979 in luaD_rawrunprotected (L=0x5c029fdd010, f=0xd8752fc03efb2220,
    ud=0x1)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/ldo.cpp:116
#7  luaD_pcall (L=0x5bf3a556000, func=0xd8752fc03efb2220, u=0x1, old_top=399, ef=771)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/ldo.cpp:464
#8  0x000005bd32d0c8ff in lua_pcall (L=0x5c029fdd010, nargs=<optimized out>, nresults=-1,
    errfunc=<optimized out>)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/lapi.cpp:833
#9  0x000005bd32d0fcf2 in luaB_pcall (L=0x5c029fdd010)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/lbaselib.cpp:377
#10 0x000005bd32d140eb in luaD_precall (L=0x5c029fdd010, func=<optimized out>, nresults=3)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/ldo.cpp:320
#11 0x000005bd32d2b2b5 in luaV_execute (L=0x5c029fdd010, nexeccalls=<optimized out>)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/lvm.cpp:620
#12 0x000005bd32d145b2 in luaD_call (L=0x5c029fdd010, func=0x5c0002df020, nResults=0)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/ldo.cpp:378
#13 0x000005bd32d14979 in luaD_rawrunprotected (L=0x5c029fdd010, f=0xd8752fc03efb2220,
    ud=0x1)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/ldo.cpp:116
#14 luaD_pcall (L=0x5bf3a556000, func=0xd8752fc03efb2220, u=0x1, old_top=399, ef=771)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/ldo.cpp:464
#15 0x000005bd32d0c8ff in lua_pcall (L=0x5c029fdd010, nargs=<optimized out>, nresults=0,
    errfunc=<optimized out>)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/lib/lua/src/lapi.cpp:833
#16 0x000005bd3283773f in CLuaHandle::RunCallInTraceback(lua_State*, LuaHashString const*, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> >*, int, int, int, bool)::ScopedLuaCall::ScopedLuaCall(CLuaHandle*, lua_State*, char const*, int, int, int, bool) (this=<optimized out>, handle=0x5bf7a868a80, state=0x5c029fdd010,
    func=0x5bd330eabd0 <CLuaHandle::DrawScreen()::cmdStr> "DrawScreen", _nInArgs=2,
    _nOutArgs=0, _errFuncIdx=0, _popErrFunc=<optimized out>)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/Lua/LuaHandle.cpp:352
#17 CLuaHandle::RunCallInTraceback (this=0x5bf7a868a80, L=0x5c029fdd010,
    hs=<optimized out>, ts=0x7e74f0201fa0, inArgs=2, outArgs=0, errFuncIndex=0,
    popErrorFunc=<optimized out>)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/Lua/LuaHandle.cpp:438
#18 0x000005bd32837b26 in CLuaHandle::RunCallInTraceback (this=0x5bf3a556000, L=0xbe2,
    hs=..., inArgs=771, outArgs=768, errFuncIndex=3, popErrFunc=<optimized out>)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/Lua/LuaHandle.cpp:448
#19 0x000005bd3284778c in CLuaHandle::RunCallIn (this=0x5bf7a868a80, L=0xbe2, hs=...,
    inArgs=2, outArgs=0)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/Lua/LuaHandle.h:389
#20 CLuaHandle::DrawScreenCommon (this=0x5bf7a868a80, cmdStr=...)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/Lua/LuaHandle.cpp:2529
#21 0x000005bd328409cb in CLuaHandle::DrawScreen (this=0x5bf7a868a80)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/Lua/LuaHandle.cpp:2546
#22 0x000005bd32bb7697 in CEventHandler::DrawScreen (this=0x5bd33267cb0 <eventHandler>)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/System/EventHandler.cpp:703
#23 0x000005bd326768ba in CGame::DrawInputReceivers (this=0x5bf9f3b1400)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/Game/Game.cpp:1562
#24 0x000005bd3267647d in CGame::Draw (this=0x5bf9f3b1400)
    at /usr/ports/pobj/recoil-rts-105.1.1pl2240/spring-spring_bar_-BAR105-.1.1-2240-gd01542d/rts/Game/Game.cpp:1518
...

Old:
----
- address cmake warning that -O2 -pipe will "very likely not sync in online mode"
- fix man page generation; looks for docbook (textproc/docbook) in configure stage, textproc/libxslt, asciidoc
- ONLY_FOR_ARCHS=amd64 really needed?
- add SHARED_LIBS +/- versioning, e.g. libunitsync.so
- Java dependencies, incl MODULES=java really needed?
- does it need Lua dependencies? Uses it at runtime at least. Add MODULES=lang/lua?
- Is -DAI_TYPES="NATIVE" really needed? (taken from FreeBSD port, also seems to be in the beyond-all-reason build options)
  -> https://github.com/beyond-all-reason/spring/releases/download/spring_bar_%7BBAR105%7D105.1.1-1544-g058c8ea/buildoptions_linux-64.txt
- remove debug flags (-O0 -g) when not needed anymore
- rework replacing std::random_shuffle based on FreeBSD example? Or use Cpp11Compat (see above)
  https://github.com/freebsd/freebsd-ports/blob/main/games/spring/files/patch-shuffle
- glob(3) workaround for tilde expansion can't expand env variables like wordexp can. Consider more complete implementation of that, and restore use of ${XDG_CONFIG_DIR} ?
- make GetProcessExecutableFile smarter - currently hardcodes /usr/local/bin/spring, but there are other binaries included in the port that need to be accounted for: spring-dedicated and spring-headless. (May need to store argv[0] in Run(), then use it here in rts/System/Platform/Misc.cpp.)
